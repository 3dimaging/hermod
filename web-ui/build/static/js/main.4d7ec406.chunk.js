(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{146:function(e,t){},147:function(e,t){},151:function(e,t,n){"use strict";n.r(t);var o=n(1),i=n.n(o),s=n(51),a=n.n(s),r=(n(62),n(52)),l=n(53),u=n(55),c=n(54),d=n(56),h=n(15),g=n(16),p=n.n(g),f=n(26),v=n(0),m=n.n(v),w=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},y=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),b=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},C=function(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},S=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==typeof t&&"function"!==typeof t?e:t},k=n(68),E=function(){function e(t){w(this,e),this.props=t,this.failCount=0,this.mqttClient=null,this.sessionId=null,this.clientId=t.clientId?t.clientId:"client"+parseInt(1e8*Math.random(),10),this.state={},this.connectTimeout=null,this.started=!1,this.onMessageArrived=this.onMessageArrived.bind(this),this.onConnect=this.onConnect.bind(this),this.mqttConnect=this.mqttConnect.bind(this)}return y(e,[{key:"setState",value:function(e){return Object.assign(this.state,e)}},{key:"start",value:function(){this.started=!0,this.mqttConnect()}},{key:"stop",value:function(){this.started=!1,this.mqttClient&&this.mqttClient.end()}},{key:"mqttConnect",value:function(){var e=this.props.mqttPort&&this.props.mqttPort>0?parseInt(this.props.mqttPort,10):9001,t=this.props.mqttServer&&this.props.mqttServer.length>0?this.props.mqttServer:window.location.hostname;console.log(["CONNECT",{host:t,port:e,username:this.props.username,password:this.props.password},this.props.subscribe]),this.mqttClient=k.connect({host:t,port:e,username:this.props.username,password:this.props.password}),this.mqttClient.on("connect",this.onConnect),this.mqttClient.on("error",console.error),this.mqttClient.on("offline",console.log),this.mqttClient.on("reconnect",console.log),this.mqttClient.on("close",console.log),this.mqttClient.on("end",console.log),this.mqttClient.on("packetsend",console.log),this.mqttClient.on("packetreceive",console.log),this.mqttClient.on("message",this.onMessageArrived)}},{key:"onConnect",value:function(e){var t=this;console.log([" SERVER CONNECTED",this.props]),this.setState({connected:!0}),this.failCount=0;var n=this.props.subscribe&&this.props.subscribe.length>0?this.props.subscribe:"#";console.log(["init sub to ",n]),t.mqttClient.subscribe(n,function(e){e&&console.log(["SUBSCRIBE ERROR",e]),console.log(["init sub oDk "]),t.afterConnect(t)})}},{key:"afterConnect",value:function(){}},{key:"onMessageArrived",value:function(e,t){}}]),e}(),I={"hermod/+/hotword/start":function(e,t,n){var o=this;return new Promise(function(e,i){var s=o.state.hotwordListening;s[t]=!0,o.setState({hotwordListening:s}),o.updateSession(t,n,function(e){return e&&(e.hotword=!0,e.hotwordDetected=!1,o.updateSessionStatus(t,e)),e}),e()})},"hermod/+/hotword/stop":function(e,t,n){var o=this;return new Promise(function(e,i){var s=o.state.hotwordListening;s[t]=!1,o.setState({hotwordListening:s}),o.updateSession(t,n,function(e){return e&&(e.hotword=!1,o.updateSessionStatus(t,e)),e}),e()})},"hermod/+/hotword/detected":function(e,t,n){var o=this;return new Promise(function(e,i){o.updateSession(t,n,function(e){return e&&(e.hotwordDetected=!0,o.updateSessionStatus(t,e)),e}),e()})},"hermod/+/nlu/started":function(e,t,n){return new Promise(function(e,t){e()})},"hermod/+/nlu/parse":function(e,t,n){return new Promise(function(e,t){e()})},"hermod/+/nlu/intent":function(e,t,n){return new Promise(function(e,t){e()})},"hermod/+/nlu/fail":function(e,t,n){return new Promise(function(e,t){e()})},"hermod/+/nlu/slot":function(e,t,n){return new Promise(function(e,t){e()})},"hermod/+/tts/say":function(e,t,n){var o=this;return new Promise(function(e,i){o.updateSession(t,n,function(e){return e&&(e.tts||(e.tts=[]),e.tts.push(n),o.updateSessionStatus(t,e)),e}),e()})},"hermod/+/tts/sayFinished":function(e,t,n){return new Promise(function(e,t){e()})},"hermod/+/asr/start":function(e,t,n){var o=this;return new Promise(function(e,i){if(n){o.resetAudioBuffer(t);var s=o.state.audioListening;s[t]=!0,o.setState({audioListening:s}),o.updateSession(t,n,function(e){return e&&n&&o.updateSessionStatus(t,e),e})}e()})},"hermod/+/asr/stop":function(e,t,n){var o=this;return new Promise(function(e,i){var s=o.state.audioListening;s[t]=!1,o.setState({audioListening:s}),o.updateSession(t,n,function(e){return e&&(o.logAudioBuffer(n),o.updateSessionStatus(t,e)),e}),e()})},"hermod/+/asr/text":function(e,t,n){var o=this;return new Promise(function(e,i){o.updateSession(t,n,function(e){return e&&(e.asr||(e.asr=[]),e.asr.push(n)),e}),e()})},"hermod/+/asr/partial":function(e,t,n){return new Promise(function(e,t){e()})},"hermod/+/dialog/start":function(e,t,n){return new Promise(function(e,t){e()})},"hermod/+/dialog/continue":function(e,t,n){return new Promise(function(e,t){e()})},"hermod/dialog/end":function(e,t,n){return new Promise(function(e,t){e()})},"hermod/+/dialog/started":function(e,t,n){var o=this;return new Promise(function(e,i){o.updateSession(t,n,function(e){return e&&(e.started=!0,e.queued=!0,e.starttimestamp=(new Date).getTime(),e.sessionId=n.sessionId,e.siteId=t,o.updateSessionStatus(t,e),o.lastSessionId[t]=n.sessionId),e}),e()})},"hermod/+/dialog/ended":function(e,t,n){var o=this;return new Promise(function(e,i){o.updateSession(t,n,function(e){return e&&(e.success=!0,e.ended=!0,e.endtimestamp=(new Date).getTime(),o.updateSessionStatus(t,e)),e}),e()})},"hermod/+/intent":function(e,t,n){var o=this;return new Promise(function(e,i){o.updateSession(t,n,function(e){return e&&(e.intents||(e.intents=[]),e.intents.push(n),o.updateSessionStatus(t,e)),e}),e()})},"hermod/+/microphone/audio":function(e,t,n){return new Promise(function(e,t){e()})}};var M,x=function(e,t){return e(t={exports:{}},t.exports),t.exports}(function(e,t){window,e.exports=function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(o,i,function(t){return e[t]}.bind(null,i));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i=function(){function e(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).sampleRate,n=void 0===t?44100:t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._sampleRate=n,this._context=this._createContext()}return o(e,[{key:"_createContext",value:function(){return window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,new AudioContext}},{key:"fetchAudio",value:function(){var e=Object(f.a)(p.a.mark(function e(){var t,n,o,i,s,a=arguments;return p.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(t=this,n=a.length,o=Array(n),i=0;i<n;i++)o[i]=a[i];return s=o.map(function(){var e=Object(f.a)(p.a.mark(function e(n){var o;return p.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(n).then(function(e){return e.arrayBuffer()});case 2:return o=e.sent,e.next=5,t._context.decodeAudioData(o);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()),e.next=4,Promise.all(s);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"mergeAudio",value:function(e){var t=this._context.createBuffer(1,this._sampleRate*this._maxDuration(e),this._sampleRate);return e.map(function(e){for(var n=e.getChannelData(0).length-1;n>=0;n--)t.getChannelData(0)[n]+=e.getChannelData(0)[n]}),t}},{key:"concatAudio",value:function(e){var t=this._context.createBuffer(1,this._totalLength(e),this._sampleRate),n=0;return e.map(function(e){t.getChannelData(0).set(e.getChannelData(0),n),n+=e.length}),t}},{key:"play",value:function(e){var t=this._context.createBufferSource();return t.buffer=e,t.connect(this._context.destination),t.start(),t}},{key:"export",value:function(e,t){var n=t||"audio/mp3",o=this._interleave(e),i=this._writeHeaders(o),s=new Blob([i],{type:n});return{blob:s,url:this._renderURL(s),element:this._renderAudioElement(s,n)}}},{key:"download",value:function(e,t){var n=t||"crunker",o=document.createElement("a");return o.style="display: none",o.href=this._renderURL(e),o.download=n+"."+e.type.split("/")[1],o.click(),o}},{key:"notSupported",value:function(e){return!this._isSupported()&&e()}},{key:"close",value:function(){return this._context.close(),this}},{key:"_maxDuration",value:function(e){return Math.max.apply(Math,e.map(function(e){return e.duration}))}},{key:"_totalLength",value:function(e){return e.map(function(e){return e.length}).reduce(function(e,t){return e+t},0)}},{key:"_isSupported",value:function(){return"AudioContext"in window}},{key:"_writeHeaders",value:function(e){var t=new ArrayBuffer(44+2*e.length),n=new DataView(t);return this._writeString(n,0,"RIFF"),n.setUint32(4,32+2*e.length,!0),this._writeString(n,8,"WAVE"),this._writeString(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,2,!0),n.setUint32(24,this._sampleRate,!0),n.setUint32(28,4*this._sampleRate,!0),n.setUint16(32,4,!0),n.setUint16(34,16,!0),this._writeString(n,36,"data"),n.setUint32(40,2*e.length,!0),this._floatTo16BitPCM(n,e,44)}},{key:"_floatTo16BitPCM",value:function(e,t,n){for(var o=0;o<t.length;o++,n+=2){var i=Math.max(-1,Math.min(1,t[o]));e.setInt16(n,i<0?32768*i:32767*i,!0)}return e}},{key:"_writeString",value:function(e,t,n){for(var o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}},{key:"_interleave",value:function(e){for(var t=e.getChannelData(0),n=2*t.length,o=new Float32Array(n),i=0,s=0;i<n;)o[i++]=t[s],o[i++]=t[s],s++;return o}},{key:"_renderAudioElement",value:function(e,t){var n=document.createElement("audio");return n.controls="controls",n.type=t,n.src=this._renderURL(e),n}},{key:"_renderURL",value:function(e){return(window.URL||window.webkitURL).createObjectURL(e)}}]),e}();t.default=i}])}),O=(M=x)&&M.__esModule&&Object.prototype.hasOwnProperty.call(M,"default")?M.default:M,_=(x.Crunker,function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return console.log("consstr hermod logger"),console.log(e),n.eventFunctions=I,n.eventCallbackFunctions=n.addCallbacks(n.props.eventCallbackFunctions),n.siteId=e.siteId?e.siteId:"site"+parseInt(1e8*Math.random(),10),n.state={sites:{},messages:[],session:{},audioListening:{},hotwordListening:{},showLogMessages:{},sessionStatus:{},sessionStatusText:{}},n.audioBuffers={},n.lastSessionId={},n.getSession=n.getSession.bind(n),n.saveSession=n.saveSession.bind(n),n.updateSession=n.updateSession.bind(n),n.logAudioBuffer=n.logAudioBuffer.bind(n),n.updateSessionStatus=n.updateSessionStatus.bind(n),n.addCallbacks=n.addCallbacks.bind(n),n.findEventCallbackFunctions=n.findEventCallbackFunctions.bind(n),n.onMessageArrived=n.onMessageArrived.bind(n),n.isConnected=n.isConnected.bind(n),n.reset=n.reset.bind(n),console.log(["LOGGER CONNECT",n.siteId,n.props]),n.mqttConnect.bind(n)(),n}return C(t,E),y(t,[{key:"reset",value:function(){this.setState({sites:{},messages:[],session:{},audioListening:{},hotwordListening:{},showLogMessages:{},sessionStatus:{},sessionStatusText:{}}),this.audioBuffers={},this.lastSessionId={}}},{key:"addCallbacks",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];console.log(["add callbacks",e]);var n=this;return this.eventCallbackFunctions=Array.isArray(this.eventCallbackFunctions)?this.eventCallbackFunctions:[],e&&Object.keys(e).map(function(o,i){var s=e[o];"function"===typeof s&&n.eventCallbackFunctions.push({subscription:o,callBack:s,oneOff:t,id:parseInt(1e8*Math.random(),10)})}),this.eventCallbackFunctions}},{key:"findEventCallbackFunctions",value:function(e){var t=this,n=[];return this.eventCallbackFunctions.map(function(o,i){t.mqttWildcard(e,o.subscription)&&n.push(o)}),n}},{key:"mqttWildcard",value:function(e,t){if(e===t)return[];if("#"===t)return[e];for(var n=[],o=String(e).split("/"),i=String(t).split("/"),s=0,a=o.length;s<a;s++)if("+"===i[s])n.push(o[s]);else{if("#"===i[s])return n.push(o.slice(s).join("/")),n;if(i[s]!==o[s])return null}return"#"===i[s]&&(s+=1),s===i.length?n:null}},{key:"generateUuid",value:function(){var e,t="";for(e=0;e<32;e+=1)switch(e){case 8:case 20:t+="-",t+=(16*Math.random()|0).toString(16);break;case 12:t+="-",t+="4";break;case 16:t+="-",t+=(4*Math.random()|8).toString(16);break;default:t+=(16*Math.random()|0).toString(16)}return t}},{key:"onMessageArrived",value:function(e,t){console.log(["ONMESSAGEARRIVED",e,t]),t.destinationName=e,t.payloadBytes=t,t.payloadString=String(t);var n=this,o=t.destinationName?t.destinationName.split("/"):[];if(o.length>1&&"hermod"===o[0]){var i=function(e){var o=n.findEventCallbackFunctions(e);o&&o.map(function(e,o){e.callBack.bind(n)(t.destinationName,s,a)})},s=o[1],a={};if(o.length>3&&("speaker"===o[2]&&"play"===o[3]||"microphone"===o[2]&&"audio"===o[3])){var r=t.payloadBytes;"microphone"===o[2]&&this.appendAudioBuffer(s,r)}else{console.log(["amessage",t.destinationName,this.state]);try{a=JSON.parse(t.payloadString)}catch(g){}var l=this.state.messages,u=this.getSession(s,a.id);u||(u={}),a.id&&(this.lastSessionId[s]=a.id),l.push({id:u.id,payload:m.a.createElement("div",{style:{backgroundColor:"lightgrey"}},m.a.createElement("hr",null),m.a.createElement("div",{style:{backgroundColor:"lightblue"}},m.a.createElement("pre",null,JSON.stringify(a,void 0,4))),m.a.createElement("hr",null),m.a.createElement("div",{style:{backgroundColor:"lightgreen"}},m.a.createElement("pre",null,JSON.stringify(u,void 0,4))),m.a.createElement("hr",null)),text:t.destinationName}),this.setState({messages:l}),console.log(["logged messages",l])}a||(a={});var c=t.destinationName,d=(n.getSession(s,a?a.id:null),null);for(var h in this.eventFunctions)if(this.mqttWildcard(c,h)){d=this.eventFunctions[h];break}if(d)d.bind(n)(t.destinationName,s,a).then(function(e){i(c)}).catch(function(e){console.log(e)});else i(c)}}},{key:"cleanSlots",value:function(e){var t={};return e&&e.map(function(e){t[e.slotName]={type:e.value.kind,value:e.value.value}}),t}},{key:"getSession",value:function(e,t){var n=null,o=this;function i(e,t){if(t=String(t),e&&e.length>0&&t&&t.length>0){if(o.state.sites&&o.state.sites.hasOwnProperty(e)&&o.state.sites[e].hasOwnProperty(t)&&o.state.sites[e][t])return o.state.sites[e][t];var n=o.state.sites?o.state.sites:{},i=o.state.sessions?o.state.sessions:{};n.hasOwnProperty(e)||(n[e]={});var s={createtimestamp:(new Date).getTime(),siteId:e,id:t};return n[e].hasOwnProperty(t)||(n[e][t]=s),i[t]=e,o.setState({sites:n,sessions:i}),n[e][t]}return console.log(["CANNOT FIND OR CREATE SESSION MISSING SITE ID",e,t]),null}if(e&&e.length>0)return t&&t.length>0?i(n=e,t):i(n=e,this.lastSessionId[n]);console.log("MISSING SITE ID IN LOGGER")}},{key:"updateSession",value:function(e,t,n){var o=t&&t.id&&t.id.length>0?t.id:null,i=this.getSession(e,o);if(i){var s=n(i);this.saveSession(i.siteId,i.id,s)}}},{key:"saveSession",value:function(e,t,n){var o=t&&t.length>0?t:"unknownSession";if(e&&e.length>0){var i=this.state.sites;i[e][o]=n,this.setState({sites:i}),this.setLogData()}}},{key:"setLogData",value:function(){this.props.setLogData&&this.props.setLogData(this.state.sites,this.state.messages,this.state.sessionStatus,this.state.sessionStatusText,this.state.hotwordListening,this.state.audioListening)}},{key:"updateSessionStatus",value:function(e,t){var n=0,o=t.sessionId;this.state.hotwordListening[e]&&(n=1),this.state.audioListening[e]&&(n=2),t.queued&&(n=3),t.started&&(n=4),t.intents&&t.asr&&t.intents.length<t.asr.length&&(n=5),t.intents&&t.asr&&t.intents.length===t.asr.length&&(n=6),t.ended&&(n=7),t.success&&(n=8);var i=["starting","hotword","listening","queued","started","transcribed","interpreted","ended","success"][n],s=this.state.sessionStatus,a=this.state.sessionStatusText;s[o]=n,a[o]=i,this.setState({sessionStatus:s,sessionStatusText:a})}},{key:"getAudioBuffer",value:function(e){if(e)return this.audioBuffers.hasOwnProperty(e)?this.audioBuffers[e]:(this.audioBuffers[e]=[],this.audioBuffers[e])}},{key:"appendAudioBuffer",value:function(e,t){!0===this.props.logAudio&&e&&(this.state.audioListening[e]&&this.getAudioBuffer(e).push(t))}},{key:"resetAudioBuffer",value:function(e){this.audioBuffers[e]=[]}},{key:"logAudioBuffer",value:function(e){var t=this,n=[],o=e.siteId;if(!0===this.props.logAudio){try{var i=new(window.AudioContext||window.webkitAudioContext);this.getAudioBuffer(o).map(function(e,t){var o=new Promise(function(t,n){if(e&&e.length>0){var o=new Uint8Array(e.length);o.set(new Uint8Array(e),0);try{i.decodeAudioData(o.buffer,function(e){t(e)})}catch(s){n()}}});n.push(o)})}catch(s){console.log(["ERROR",s])}Promise.all(n).then(function(n){var i=new O;try{var a=i.export(i.concatAudio(n),"audio/wav");t.updateSession(o,e,function(e){return e.audio||(e.audio=[]),t.blobToDataUrl(a.blob).then(function(n){e.audio.push(n),t.resetAudioBuffer(o),t.setLogData()}),e})}catch(s){console.log(s.message)}})}}},{key:"blobToDataUrl",value:function(e){return new Promise(function(t,n){var o=new FileReader;o.onerror=n,o.onload=function(e){return t(o.result)},o.readAsDataURL(e)})}},{key:"sendMqtt",value:function(e,t){console.log(["SEND MQTT",this.state.connected,e,t]),this.state.connected&&this.mqttClient.publish(e,JSON.stringify(t))}},{key:"sendAudioMqtt",value:function(e,t){this.state.connected&&this.mqttClient.publish(e,t)}},{key:"say",value:function(e,t){if(console.log(["SAY",this.state.connected,destination,payload]),this.state&&this.state.connected){var n={text:t};this.mqttClient.publish("hermod/"+e+"/tts/say",JSON.stringify(n))}}},{key:"isConnected",value:function(){return this.state.connected}}]),t}()),N=function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.props=e,n.state={},n.logger=null,n.queueOneOffCallbacks=n.queueOneOffCallbacks.bind(n),n.connectToLogger=n.connectToLogger.bind(n),n}return C(t,e),y(t,[{key:"componentDidMount",value:function(){this.connectToLogger(this.props.logger,{})}},{key:"connectToLogger",value:function(e,t){return e?(e.addCallbacks(t),this.logger=e,this.logger):(this.logger=new _(Object.assign({logAudio:!1,setLogData:this.setLogData,eventCallbackFunctions:t},this.props)),this.logger)}},{key:"queueOneOffCallbacks",value:function(e){this.logger&&this.logger.addCallbacks(e,!0)}},{key:"sendMqtt",value:function(e,t){this.logger&&this.logger.sendMqtt(e,t)}},{key:"setLogData",value:function(e,t,n,o,i,s){this.setState(this.state)}},{key:"sendHotwordToggleOn",value:function(e){this.sendMqtt("hermod/"+e+"/hotword/start",{})}},{key:"sendHotwordDetected",value:function(e,t){this.sendMqtt("hermod/"+e+"/hotword/detected",{hotword:t})}},{key:"sendStartSession",value:function(e,t,n){var o={};t&&(o.customData=JSON.stringify(t)),this.sendMqtt("hermod/"+e+"/dialog/start",o)}},{key:"sendSayFinished",value:function(e,t){this.sendMqtt("hermod/"+this.siteId+"/tts/finished",{id:e,sessionId:t})}},{key:"sendPlayFinished",value:function(e,t){this.sendMqtt("hermod/"+this.siteId+"/speaker/finished",{id:t})}},{key:"sendEndSession",value:function(e,t,n){console.log(["send end sess",e,t,n]);var o={id:t};n&&n.length>0&&(o.text=n),this.sendMqtt("hermod/"+e+"/dialog/end",o)}},{key:"sendAsrToggleOn",value:function(e){this.sendMqtt("hermod/"+e+"/asr/start",{})}},{key:"sendAsrStopListening",value:function(e){this.sendMqtt("hermod/"+e+"/asr/stop",{siteId:e})}},{key:"sendAsrStartListening",value:function(e){this.sendMqtt("hermod/"+e+"/asr/start",{})}},{key:"sendAsrToggleOff",value:function(e){this.sendMqtt("hermod/"+e+"/asr/stop",{})}},{key:"sendFeedbackToggleOn",value:function(e){}},{key:"sendFeedbackToggleOff",value:function(e){}},{key:"render",value:function(){return m.a.createElement("b",{id:"Hermodreactcomponent"})}}]),t}(v.Component),L=function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));n.startRecording=function(){console.log("start recording"),this.setState({lastIntent:"",lastTts:"",lastTranscript:"",showMessage:!1}),this.sendStartSession(this.siteId,{startedBy:"Hermodreactmicrophone",user:this.props.user?this.props.user._id:""})},n.stopRecording=function(){console.log(["stop rec",this.logger]);var e=this.logger.getSession(this.siteId,null);console.log(e||"no session"),e&&this.sendEndSession(e.siteId,e.id)};var o=n;if(n.state={},!e.siteId||0===e.siteId.length)throw"Hermod Microphone must be configured with a siteId property";n.state={recording:!1,messages:[],lastIntent:"",lastTts:"",lastTranscript:"",showMessage:!1,activated:!1,speaking:!1,showConfig:!1,listening:!1,sessionId:""},n.siteId=e.siteId,n.clientId=e.clientId?e.clientId:"client"+parseInt(1e8*Math.random(),10),n.hotwordId=e.hotwordId?e.hotwordId:"default",n.context=null,n.gainNode=null,n.messageTimeout=null,n.speakingTimeout=null,n.speechEvents=null,n.startRecording=n.startRecording.bind(n),n.stopRecording=n.stopRecording.bind(n),n.startRecorder=n.startRecorder.bind(n),n.sendAudioBuffer=n.sendAudioBuffer.bind(n),n.audioBufferToWav=n.audioBufferToWav.bind(n),n.reSample=n.reSample.bind(n),n.encodeWAV=n.encodeWAV.bind(n),n.interleave=n.interleave.bind(n),n.flashState=n.flashState.bind(n),n.activate=n.activate.bind(n),n.deactivate=n.deactivate.bind(n),n.showConfig=n.showConfig.bind(n),n.showConfigNow=n.showConfigNow.bind(n),n.clearConfigTimer=n.clearConfigTimer.bind(n),n.waitingForSession=null,n.configTimeout=null;var i={"hermod/+/asr/text":function(e,t,n){t&&t.length>0&&n.text&&n.text.length>0&&o.flashState("lastTranscript",n.text)},"hermod/+/tts/say":function(e,t,n){t&&t.length>0&&n.text&&n.text.length>0&&o.flashState("lastTts",n.text)},"hermod/+/microphone/start":function(e,t,n){t&&t.length>0&&o.setState({sending:!0})},"hermod/+/microphone/stop":function(e,t,n){t&&t.length>0&&o.setState({sending:!1})}};return n.logger=n.connectToLogger(e.logger,i),n}return C(t,N),y(t,[{key:"componentDidMount",value:function(){this.startRecorder()}},{key:"showConfig",value:function(e){console.log("show config");var t=this;this.configTimeout=setTimeout(function(){console.log("show now"),t.props.showConfig?t.props.showConfig():t.deactivate()},1e3)}},{key:"showConfigNow",value:function(e){console.log("show config now"),e.preventDefault(),e.stopPropagation(),this.props.showConfig?this.props.showConfig():this.deactivate()}},{key:"clearConfigTimer",value:function(){this.configTimeout&&clearTimeout(this.configTimeout)}},{key:"activate",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];console.log("activate");var t=this;localStorage.setItem(this.appendUserId("Hermodmicrophone_enabled",this.props.user),"true"),e&&setTimeout(function(){t.startRecording()},500),t.setState({activated:!0,sending:!1})}},{key:"deactivate",value:function(){console.log("deactivate"),localStorage.setItem(this.appendUserId("Hermodmicrophone_enabled",this.props.user),"false"),this.setState({activated:!1,sending:!1})}},{key:"startRecorder",value:function(){var e=this;navigator.getUserMedia||(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia);try{navigator.getUserMedia?navigator.getUserMedia({audio:!0},function(t){console.log("got navigator");var n=new(window.AudioContext||window.webkitAudioContext);e.setState({activated:!0}),e.gainNode=n.createGain(),e.gainNode.gain.value=e.props.config.inputvolume>0?e.props.config.inputvolume/100:.5;var o=n.createMediaStreamSource(t),i=n.createScriptProcessor(256,1,1);i.onaudioprocess=function(t){e.state.sending&&(t.inputBuffer.getChannelData(0),e.sendAudioBuffer(t.inputBuffer,n.sampleRate))},e.props.addInputGainNode&&e.props.addInputGainNode(e.gainNode);o.connect(e.gainNode),e.gainNode.connect(i),i.connect(n.destination)},function(e){console.log(["MIC Error capturing audio.",e])}):console.log("MIC getUserMedia not supported in this browser.")}catch(t){console.log(t)}}},{key:"addInputGainNode",value:function(e){this.inputGainNodes.push(e)}},{key:"appendUserId",value:function(e,t){return t&&t._id?e+"_"+t._id:e}},{key:"flashState",value:function(e,t){var n=this;if("no"!==this.props.config.enablenotifications&&e&&e.length>0&&t&&t.length>0){this.messageTimeOut&&clearTimeout(this.messageTimeOut);var o={showMessage:!0};"lastTranscript"===e&&(o.lastIntent="",o.lastTts=""),o[e]=t,this.setState(o),setTimeout(function(){n.setState({showMessage:!1})},n.props.messageTimeout>0?n.props.messageTimeout:1e4)}}},{key:"sendAudioBuffer",value:function(e,t){var n=this;e&&this.reSample(e,16e3,function(e){var t=n.audioBufferToWav(e);n.logger.sendAudioMqtt("hermod/"+n.siteId+"/microphone/audio",t)},t)}},{key:"convertFloat32ToInt16",value:function(e){for(var t=e.length,n=new Int16Array(t);t--;)n[t]=32767*Math.min(1,e[t]);return n.buffer}},{key:"flattenArray",value:function(e,t){for(var n=this.convertFloat32ToInt16(e),o=new Float32Array(t),i=0,s=0;s<n.length;s++){var a=n[s];o.set(a,i),i+=a.length}return o}},{key:"reSample",value:function(e,t,n,o){var i=isNaN(o)?44100:o,s=e&&e.numberOfChannels?e.numberOfChannels:1,a=e.length*t/i,r=new OfflineAudioContext(s,a,t),l=r.createBufferSource();l.buffer=e,l.connect(r.destination),l.start(0),r.startRendering().then(function(e){n(e)}).catch(function(e){console.log(e)})}},{key:"audioBufferToWav",value:function(e,t){t=t||{};var n,o=e.numberOfChannels,i=e.sampleRate,s=t.float32?3:1,a=3===s?32:16;return n=2===o?this.interleave(e.getChannelData(0),e.getChannelData(1)):e.getChannelData(0),this.encodeWAV(n,s,i,o,a)}},{key:"encodeWAV",value:function(e,t,n,o,i){var s=i/8,a=o*s,r=new ArrayBuffer(44+e.length*s),l=new DataView(r);return this.writeString(l,0,"RIFF"),l.setUint32(4,36+e.length*s,!0),this.writeString(l,8,"WAVE"),this.writeString(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,t,!0),l.setUint16(22,o,!0),l.setUint32(24,n,!0),l.setUint32(28,n*a,!0),l.setUint16(32,a,!0),l.setUint16(34,i,!0),this.writeString(l,36,"data"),l.setUint32(40,e.length*s,!0),1===t?this.floatTo16BitPCM(l,44,e):this.writeFloat32(l,44,e),r}},{key:"interleave",value:function(e,t){for(var n=e.length+t.length,o=new Float32Array(n),i=0,s=0;i<n;)o[i++]=e[s],o[i++]=t[s],s++;return o}},{key:"writeFloat32",value:function(e,t,n){for(var o=0;o<n.length;o++,t+=4)e.setFloat32(t,n[o],!0)}},{key:"floatTo16BitPCM",value:function(e,t,n){for(var o=0;o<n.length;o++,t+=2){var i=Math.max(-1,Math.min(1,n[o]));e.setInt16(t,i<0?32768*i:32767*i,!0)}}},{key:"writeString",value:function(e,t,n){for(var o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}},{key:"render",value:function(){this.props.text;var e=this.props.buttonStyle?this.props.buttonStyle:{},t=this.props.size&&this.props.size.length>0?this.props.size:"2em";e.width=t,e.height=t;var n=this.props.position&&this.props.position.length>0?this.props.position:"topright";e.position="fixed","topleft"===n?(e.top=0,e.left=0):"topright"===n?(e.top=0,e.right=0):"bottomleft"===n?(e.bottom=0,e.left=0):"bottomright"===n&&(e.bottom=0,e.right=0);var o=0;this.state.activated&&(o=2),this.state.sending&&(o=3);var i="black",s=2;3==o?(i=this.state.speaking?"darkgreen":this.props.borderColor?this.props.borderColor:"green",e.backgroundColor="lightgreen",this.state.speaking&&(s=3)):1==o?(i=this.state.speaking?"darkorange":this.props.borderColor?this.props.borderColor:"orange",e.backgroundColor="lightorange",this.state.speaking&&(s=3)):2==o?(i=this.state.speaking?"orangered":this.props.borderColor?this.props.borderColor:"red",e.backgroundColor="pink",this.state.speaking&&(s=3)):(i=this.props.borderColor?this.props.borderColor:"black",e.backgroundColor="lightgrey"),e.padding||(e.padding="0.5em"),e.margin||(e.margin="0.5em"),e.border=s+"px solid "+i,e.borderRadius||(e.borderRadius="100px");var a=m.a.createElement("svg",{style:e,"aria-hidden":"true","data-prefix":"fas","data-icon":"microphone",className:"svg-inline--fa fa-microphone fa-w-11",role:"img",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 352 512"},m.a.createElement("path",{fill:"currentColor",d:"M176 352c53.02 0 96-42.98 96-96V96c0-53.02-42.98-96-96-96S80 42.98 80 96v160c0 53.02 42.98 96 96 96zm160-160h-16c-8.84 0-16 7.16-16 16v48c0 74.8-64.49 134.82-140.79 127.38C96.71 376.89 48 317.11 48 250.3V208c0-8.84-7.16-16-16-16H16c-8.84 0-16 7.16-16 16v40.16c0 89.64 63.97 169.55 152 181.69V464H96c-8.84 0-16 7.16-16 16v16c0 8.84 7.16 16 16 16h160c8.84 0 16-7.16 16-16v-16c0-8.84-7.16-16-16-16h-56v-33.77C285.71 418.47 352 344.9 352 256v-48c0-8.84-7.16-16-16-16z"})),r=m.a.createElement("svg",{style:e,"aria-hidden":"true","data-prefix":"fas","data-icon":"microphone-slash",className:"svg-inline--fa fa-microphone-slash fa-w-20",role:"img",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 640 512"},m.a.createElement("path",{fill:"currentColor",d:"M633.82 458.1l-157.8-121.96C488.61 312.13 496 285.01 496 256v-48c0-8.84-7.16-16-16-16h-16c-8.84 0-16 7.16-16 16v48c0 17.92-3.96 34.8-10.72 50.2l-26.55-20.52c3.1-9.4 5.28-19.22 5.28-29.67V96c0-53.02-42.98-96-96-96s-96 42.98-96 96v45.36L45.47 3.37C38.49-2.05 28.43-.8 23.01 6.18L3.37 31.45C-2.05 38.42-.8 48.47 6.18 53.9l588.36 454.73c6.98 5.43 17.03 4.17 22.46-2.81l19.64-25.27c5.41-6.97 4.16-17.02-2.82-22.45zM400 464h-56v-33.77c11.66-1.6 22.85-4.54 33.67-8.31l-50.11-38.73c-6.71.4-13.41.87-20.35.2-55.85-5.45-98.74-48.63-111.18-101.85L144 241.31v6.85c0 89.64 63.97 169.55 152 181.69V464h-56c-8.84 0-16 7.16-16 16v16c0 8.84 7.16 16 16 16h160c8.84 0 16-7.16 16-16v-16c0-8.84-7.16-16-16-16z"}));m.a.createElement("svg",{"aria-hidden":"true",style:{height:"1.1em"},role:"img",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},m.a.createElement("path",{fill:"currentColor",d:"M500.333 0h-47.411c-6.853 0-12.314 5.729-11.986 12.574l3.966 82.759C399.416 41.899 331.672 8 256.001 8 119.34 8 7.899 119.526 8 256.187 8.101 393.068 119.096 504 256 504c63.926 0 122.202-24.187 166.178-63.908 5.113-4.618 5.354-12.561.482-17.433l-33.971-33.971c-4.466-4.466-11.64-4.717-16.38-.543C341.308 415.448 300.606 432 256 432c-97.267 0-176-78.716-176-176 0-97.267 78.716-176 176-176 60.892 0 114.506 30.858 146.099 77.8l-101.525-4.865c-6.845-.328-12.574 5.133-12.574 11.986v47.411c0 6.627 5.373 12 12 12h200.333c6.627 0 12-5.373 12-12V12c0-6.627-5.373-12-12-12z"})),m.a.createElement("svg",{"aria-hidden":"true",style:{height:"1.4em"},role:"img",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},m.a.createElement("path",{fill:"currentColor",d:"M440.5 88.5l-52 52L415 167c9.4 9.4 9.4 24.6 0 33.9l-17.4 17.4c11.8 26.1 18.4 55.1 18.4 85.6 0 114.9-93.1 208-208 208S0 418.9 0 304 93.1 96 208 96c30.5 0 59.5 6.6 85.6 18.4L311 97c9.4-9.4 24.6-9.4 33.9 0l26.5 26.5 52-52 17.1 17zM500 60h-24c-6.6 0-12 5.4-12 12s5.4 12 12 12h24c6.6 0 12-5.4 12-12s-5.4-12-12-12zM440 0c-6.6 0-12 5.4-12 12v24c0 6.6 5.4 12 12 12s12-5.4 12-12V12c0-6.6-5.4-12-12-12zm33.9 55l17-17c4.7-4.7 4.7-12.3 0-17-4.7-4.7-12.3-4.7-17 0l-17 17c-4.7 4.7-4.7 12.3 0 17 4.8 4.7 12.4 4.7 17 0zm-67.8 0c4.7 4.7 12.3 4.7 17 0 4.7-4.7 4.7-12.3 0-17l-17-17c-4.7-4.7-12.3-4.7-17 0-4.7 4.7-4.7 12.3 0 17l17 17zm67.8 34c-4.7-4.7-12.3-4.7-17 0-4.7 4.7-4.7 12.3 0 17l17 17c4.7 4.7 12.3 4.7 17 0 4.7-4.7 4.7-12.3 0-17l-17-17zM112 272c0-35.3 28.7-64 64-64 8.8 0 16-7.2 16-16s-7.2-16-16-16c-52.9 0-96 43.1-96 96 0 8.8 7.2 16 16 16s16-7.2 16-16z"})),this.props.config;return m.a.createElement("div",{id:"hermodreactmicrophone",style:{zIndex:"9999"}},"sending ",this.state.sending?"AA":"BB",!this.state.activated&&m.a.createElement("span",{onClick:this.activate},r),this.state.activated&&this.state.sending&&m.a.createElement("span",{onTouchStart:this.showConfig,onTouchEnd:this.clearConfigTimer,onMouseDown:this.showConfig,onMouseUp:this.clearConfigTimer,onContextMenu:this.showConfigNow,onClick:this.stopRecording},a),this.state.activated&&!this.state.sending&&m.a.createElement("span",{onTouchStart:this.showConfig,onTouchEnd:this.clearConfigTimer,onMouseDown:this.showConfig,onMouseUp:this.clearConfigTimer,onContextMenu:this.showConfigNow,onClick:this.startRecording},r),this.state.showMessage&&m.a.createElement("div",{style:{padding:"1em",borderRadius:"20px",backgroundColor:"skyblue",margin:"5%",width:"90%",top:"1.7em",color:"black",border:"2px solid blue",zIndex:"9999"}},this.state.lastTranscript&&m.a.createElement("div",{style:{fontStyle:"italic"}},this.state.lastTranscript),!1,this.state.lastTts&&m.a.createElement("div",null,this.state.lastTts)),m.a.createElement("div",{id:"audio"}))}}]),t}(),T=function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e)),o=n;if(!e.siteId||0===e.siteId.length)throw"Speaker must be configured with a siteId property";n.playSound=n.playSound.bind(n),n.setVolume=n.setVolume.bind(n),n.state={volume:.5};var i={"hermod/#/speaker/play":function(e,t,n){t&&t.length>0&&o.playSound(n).then(function(){o.sendMqtt("hermod/"+t+"/speaker/finished",{})})},"hermod/#/hotword/detected":function(e,t,n){}};return n.logger=n.connectToLogger(e.logger,i),n}return C(t,N),y(t,[{key:"setVolume",value:function(e){this.setState({volume:e})}},{key:"playSound",value:function(e){var t=this;return new Promise(function(n,o){if(e&&"no"!==t.props.config.enableaudio){var i=new Uint8Array(e.length);i.set(new Uint8Array(e),0);var s=new(window.AudioContext||window.webkitAudioContext),a=s.createGain();a.gain.value=t.props.config.outputvolume/100?t.props.config.outputvolume/100:.5,s.decodeAudioData(i.buffer,function(e){var t=s.createBufferSource();t.buffer=e,t.connect(a),a.connect(s.destination),t.start(0),t.onended=function(){n()}})}else n()})}},{key:"render",value:function(){return m.a.createElement("span",{id:"Hermodreactspeaker"})}}]),t}(),A=function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e)),o=n;n.state={};var i={"hermod/intent/#":function(e,t){var n=t.destinationName?t.destinationName.split("/"):[];if(n.length>0&&"hermes"===n[0]&&n.length>1&&"intent"===n[1]){var i={},s=n[2];if(s&&s.length>0)try{if(i=JSON.parse(t.payloadString),o.props.intents&&o.props.intents.hasOwnProperty(s)&&o.props.intents[s]){var a=o.props.intents[s].bind(o)(i);a&&a.then?a.then(function(e){o.sendEndSession.bind(o)(i.sessionId)}).catch(function(e){o.sendEndSession.bind(o)(i.sessionId)}):o.sendEndSession.bind(o)(i.sessionId)}else o.sendEndSession.bind(o)(i.sessionId)}catch(r){}}}};return n.logger=n.connectToLogger(e.logger,i),n}return C(t,N),y(t,[{key:"cleanSlots",value:function(e){var t={};return e&&e.map(function(e){t[e.slotName]={type:e.value.kind,value:e.value.value}}),t}},{key:"render",value:function(){return m.a.createElement("span",{id:"Hermodreactappserver"})}}]),t}(),D={};D.keywordIDs={"ok lamp":new Uint8Array([172,36,117,33,20,61,42,231,10,133,117,76,72,49,91,68,75,182,232,195,119,48,213,172,202,84,6,41,189,21,202,144,85,129,174,33,106,4,30,90,157,100,131,12,4,3,107,232,34,46,25,191,126,43,77,140,80,39,182,17,243,23,195,249,227,105,25,38,190,13,173,120,116,97,75,184,222,131,28,185,161,6,39,119,3,178,36,130]),"navy blue":new Uint8Array([217,54,178,204,93,187,43,102,174,187,57,243,36,244,2,242,185,90,247,215,141,2,188,123,163,4,179,253,44,11,156,16,44,40,111,101,63,185,57,8,68,98,71,58,216,109,231,74,217,100,80,107,208,57,126,67,5,235,248,194,231,171,245,57,136,212,153,60,45,42,242,235,105,91,52,123,81,97,131,130,8,118,223,134,171,232,131,72])};var P=function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));if(n.sensitivities=new Float32Array([1]),n.hotwordManager=null,!e.siteId||0===e.siteId.length)throw"HOTWORD Server must be configured with a siteId property";var o=n;o.props=e,n.gainNode=null,n.hotwordId=n.props.hotwordId&&n.props.hotwordId.length>0?n.props.hotwordId:"default",n.sendHotwordDetected=n.sendHotwordDetected.bind(n),n.sendHotwordToggleOn=n.sendHotwordToggleOn.bind(n),n.startHotword=n.startHotword.bind(n),n.stopHotword=n.stopHotword.bind(n),n.hotwordCallback=n.hotwordCallback.bind(n);var i={"hermod/#/hotword/start":function(e,t,n){t&&t.length>0&&o.startHotword(t)},"hermod/#/hotword/stop":function(e,t,n){t&&t.length>0&&o.stopHotword()}};return n.logger=n.connectToLogger(e.logger,i),n}return C(t,N),y(t,[{key:"componentDidMount",value:function(){var e=this;this.props.config.hotword.startsWith("browser:")&&setTimeout(function(){e.startHotword(e.props.siteId)},1e3)}},{key:"componentDidUpdate",value:function(e,t){var n=this;return e.inputvolume,this.props.inputvolume,e.config.hotword!=this.props.config.hotword&&(this.hotwordManager=null,this.props.config.hotword.startsWith("browser:")&&setTimeout(function(){n.startHotword(n.props.siteId)},1e3)),!1}},{key:"stopHotword",value:function(){this.hotwordManager&&this.hotwordManager.pauseProcessing()}},{key:"startHotword",value:function(e){if(e===this.props.siteId)if(null===this.hotwordManager){var t=this.props.config.hotword.split(":");if(t.length>1){var n=t[1];this.hotwordManager=new PicovoiceAudioManager(this.props.addInputGainNode,this.props.config.inputvolume);var o=this.props.config.hotwordsensitivity?this.props.config.hotwordsensitivity/100:.9,i=new Float32Array([o]),s=null;D.keywordIDs.hasOwnProperty(n)&&(s=D.keywordIDs[n],this.hotwordManager.start(Porcupine.create([s],i),this.hotwordCallback,function(e){console.log(["HOTWORD error",e])}))}}else this.hotwordManager&&this.hotwordManager.continueProcessing()}},{key:"hotwordCallback",value:function(e){!isNaN(e)&&parseInt(e,10)>=0&&this.sendStartSession(this.props.siteId,{startedBy:"Hermodreacthotword",user:this.props.user?this.props.user._id:""})}},{key:"render",value:function(){return m.a.createElement("span",{id:"Hermodreacthotwordserver"})}}]),t}(),F=function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));if(!e.siteId||0===e.siteId.length)throw"TTS Server must be configured with a siteId property";var o=n,i={"hermod/#/tts/say":function(e,t,n){t&&t.length>0&&(n.text&&n.text.length>0&&o.say(n.text),o.sendMqtt("hermod/"+t+"/tts/sayFinished",{id:n.id}))}};return n.logger=n.connectToLogger(e.logger,i),n}return C(t,N),y(t,[{key:"componentDidMount",value:function(){this.initSpeechSynthesis()}},{key:"say",value:function(e){if(console.log(["TTS SAY",this.props,this.props.config,this.props.config.enablevoice]),"no"!==this.props.config.enabletts){var t=this.props.config&&this.props.config.ttsvoice?this.props.config.ttsvoice:"default";if("default"===t)speak(e,{amplitude:isNaN(parseFloat(this.props.config.voicevolume))?70:parseFloat(this.props.config.voicevolume),pitch:isNaN(parseFloat(this.props.config.voicepitch))?50:parseFloat(this.props.config.voicepitch),speed:isNaN(parseFloat(this.props.config.voicerate))?175:2.2*parseFloat(this.props.config.voicerate)});else{var n=new SpeechSynthesisUtterance;n.text=e,n.volume=isNaN(parseFloat(this.props.config.voicevolume))?50:parseFloat(this.props.config.voicevolume),n.rate=isNaN(parseFloat(this.props.config.voicerate))?.5:parseFloat(this.props.config.voicerate)/100,n.pitch=isNaN(parseFloat(this.props.config.voicepitch))?50:parseFloat(this.props.config.voicepitch),speechSynthesis.getVoices().forEach(function(e,o){e.name===t&&(n.voice=e),window.speechSynthesis.speak(n)})}}}},{key:"initSpeechSynthesis",value:function(){var e=this;if("speechSynthesis"in window){var t=function(){var t=speechSynthesis.getVoices(),n=[];t.forEach(function(e,t){n.push({name:e.name,label:e.name})}),n.push({name:"default",label:"Browser Generated"}),e.setState({voices:n})};t(),window.speechSynthesis.onvoiceschanged=function(e){t()}}else{var n=[];n.push({name:"default",label:"Browser Generated"}),e.setState({voices:n})}}},{key:"render",value:function(){return m.a.createElement("b",{id:"Hermodreacttts"})}}]),t}(),B=function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={showLogMessages:{},showLog:{}},n.toggleMessageExpansion=n.toggleMessageExpansion.bind(n),n.isLogMessageExpanded=n.isLogMessageExpanded.bind(n),n.isLogExpanded=n.isLogExpanded.bind(n),n.toggleLogExpansion=n.toggleLogExpansion.bind(n),n}return C(t,e),y(t,[{key:"toggleMessageExpansion",value:function(e,t){var n=this.state.showLogMessages;this.isLogMessageExpanded(t)?n[t]=!1:n[t]=!0,this.setState({showLogMessages:n})}},{key:"toggleLogExpansion",value:function(e,t){var n=this.state.showLog;this.isLogExpanded(t)?n[t]=!1:n[t]=!0,this.setState({showLog:n})}},{key:"isLogMessageExpanded",value:function(e){return!(!this.state.showLogMessages.hasOwnProperty(e)||!this.state.showLogMessages[e])}},{key:"isLogExpanded",value:function(e){return!(!this.state.showLog.hasOwnProperty(e)||!this.state.showLog[e])}},{key:"render",value:function(){return m.a.createElement("b",null,"logger")}}]),t}(v.Component),U=function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={showLogMessages:{}},n.toggleMessageExpansion=n.toggleMessageExpansion.bind(n),n.isLogMessageExpanded=n.isLogMessageExpanded.bind(n),n}return C(t,e),y(t,[{key:"toggleMessageExpansion",value:function(e,t){var n=this.state.showLogMessages;this.isLogMessageExpanded(t)?n[t]=!1:n[t]=!0,this.setState({showLogMessages:n})}},{key:"isLogMessageExpanded",value:function(e){return!(!this.state.showLogMessages.hasOwnProperty(e)||!this.state.showLogMessages[e])}},{key:"render",value:function(){var e=this;if(this.props.messages){var t=e.props.messages.map(function(t,n){return m.a.createElement("div",{key:n},m.a.createElement("button",{onClick:function(t){return e.toggleMessageExpansion(t,n)}},"+"),"\xa0\xa0",t.text,e.isLogMessageExpanded(n)&&m.a.createElement("pre",null,t.payload))});return m.a.createElement("div",null,t)}}}]),t}(v.Component),R={};if(R.mediaDevices=navigator.mediaDevices?navigator.mediaDevices:(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia?{getUserMedia:function(e){return new Promise(function(t,n){navigator.getUserMedia.call(navigator,e,t,n)})}}:void 0),!R.mediaDevices)throw alert("mediaDevices() not supported."),new Error("mediaDevices() not supported.");window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;var q=function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={volume:0,debug:!1},n}return C(t,e),y(t,[{key:"componentDidMount",value:function(){var e=function(e){for(var t,n=e.inputBuffer.getChannelData(0),o=0,i=0;i<n.length;i++)o+=(t=n[i])*t;var s=Math.sqrt(o/n.length);this.setState({volume:Math.max(s,this.state.volume*this.averaging)}),this.state.volume>(this.props.volumeWarning>0?this.props.volumeWarning:.25)?this.canvasCtx.fillStyle=this.props.style.tooLoudColor?this.props.style.tooLoudColor:"#FF0000":this.canvasCtx.fillStyle=this.props.style.color?this.props.style.color:"#00FF48",this.canvasCtx.clearRect(0,0,this.canvasCtx.canvas.width,this.canvasCtx.canvas.height),this.canvasCtx.fillRect(0,this.canvasCtx.canvas.height*(1-4*this.state.volume),this.canvasCtx.canvas.width,this.canvasCtx.canvas.height)}.bind(this);R.mediaDevices.getUserMedia({audio:!0}).then(function(t){var n=new AudioContext,o=n.createMediaStreamSource(t),i=n.createScriptProcessor(256),s=n.createGain();s.gain.value=this.props.inputvolume>0?this.props.inputvolume/100:.5,this.averaging=.95,this.canvasCtx=this.refs.canvas.getContext("2d"),this.canvasCtx.fillStyle=this.props.style.color?this.props.style.color:"#00FF48",i.onaudioprocess=e,i.connect(n.destination),s.connect(i),o.connect(s),this.props.addInputGainNode&&this.props.addInputGainNode(s)}.bind(this)).catch(function(e){console.log("Error occurred while initalizing audio input: "+e.toString())})}},{key:"render",value:function(){var e=this.props.style?Object.assign({},this.props.style):{};return e.height=this.props.style.height>0?this.props.style.height:78,e.width=this.props.style.width>0?this.props.style.width:30,m.a.createElement("canvas",{style:e,ref:"canvas",width:e.width,height:e.height})}}]),t}(v.Component),j=function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));if(!e.siteId||0===e.siteId.length)throw"Config must be configured with a siteId property";return n.hideConfig=n.hideConfig.bind(n),n.logger=n.connectToLogger(e.logger,{}),n.resetConfig=n.resetConfig.bind(n),n}return C(t,N),y(t,[{key:"componentDidMount",value:function(){this.loadSpeechSynthesisVoices.bind(this)()}},{key:"sendTestSay",value:function(e){e.preventDefault(),this.sendMqtt("hermod/tts/say",{siteId:this.props.siteId,text:"This is a test to hear how I speak."})}},{key:"resetConfig",value:function(e){e.preventDefault();var t=this.getDefaultConfig();this.setState({config:t}),localStorage.setItem(this.appendUserId("Hermodmicrophone_config",this.props.user),JSON.stringify(t)),this.props.configurationChange&&this.props.configurationChange(t)}},{key:"getDefaultConfig",value:function(){return{inputvolume:"70",outputvolume:"70",voicevolume:"70",ttsvoice:"default",voicerate:"50",voicepitch:"50",hotword:"browser:oklamp",hotwordsensitivity:"50",enabletts:"yes",enableaudio:"yes",enablenotifications:"yes"}}},{key:"appendUserId",value:function(e,t){return t&&t._id?e+"_"+t._id:e}},{key:"configurationChange",value:function(e){var t=this,n=this.props.config;n[e.target.id]=e.target.value,this.setState({config:n}),"inputvolume"===e.target.id&&this.props.inputGainNodes.map(function(e){e.gain.value=t.props.config.inputvolume/100}),localStorage.setItem(this.appendUserId("Hermodmicrophone_config",this.props.user),JSON.stringify(n)),this.props.configurationChange&&this.props.configurationChange(this.props.config)}},{key:"loadSpeechSynthesisVoices",value:function(){var e=this;if("speechSynthesis"in window){var t=function(){var t=speechSynthesis.getVoices(),n=[];t.forEach(function(e,t){n.push({name:e.name,label:e.name})}),n.push({name:"default",label:"Browser Generated"}),e.setState({voices:n})};t(),window.speechSynthesis.onvoiceschanged=function(e){t()}}else{var n=[];n.push({name:"default",label:"Browser Generated"}),e.setState({voices:n})}}},{key:"hideConfig",value:function(){this.props.hideConfig&&this.props.hideConfig()}},{key:"render",value:function(){var e=this.state.voices&&this.state.voices.map(function(e){return m.a.createElement("option",{key:e.name,value:e.name},e.label)}),t=m.a.createElement("svg",{"aria-hidden":"true",style:{height:"1.1em"},role:"img",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},m.a.createElement("path",{fill:"currentColor",d:"M500.333 0h-47.411c-6.853 0-12.314 5.729-11.986 12.574l3.966 82.759C399.416 41.899 331.672 8 256.001 8 119.34 8 7.899 119.526 8 256.187 8.101 393.068 119.096 504 256 504c63.926 0 122.202-24.187 166.178-63.908 5.113-4.618 5.354-12.561.482-17.433l-33.971-33.971c-4.466-4.466-11.64-4.717-16.38-.543C341.308 415.448 300.606 432 256 432c-97.267 0-176-78.716-176-176 0-97.267 78.716-176 176-176 60.892 0 114.506 30.858 146.099 77.8l-101.525-4.865c-6.845-.328-12.574 5.133-12.574 11.986v47.411c0 6.627 5.373 12 12 12h200.333c6.627 0 12-5.373 12-12V12c0-6.627-5.373-12-12-12z"})),n={marginBottom:"0.5em",fontSize:"0.9em"},o=this.props.config;return m.a.createElement("div",null,m.a.createElement("div",{style:{minHeight:"25em",margin:"1em",padding:"1em",width:"90%",border:"2px solid black",borderRadius:"10px",backgroundColor:"white",zIndex:"9"}},m.a.createElement("button",{style:{float:"right",fontSize:"1.6em",fontWeight:"bold",border:"2px solid black",borderRadius:"50px"},onClick:this.hideConfig},"X"),m.a.createElement("div",{style:{float:"left",marginRight:"2em"}},status>=2&&m.a.createElement("span",{onClick:this.deactivate},m.a.createElement("button",{className:"btn btn-danger",style:{fontSize:"1.5em"}}," ",stopIcon2," Disable "))),m.a.createElement("h1",null,"Microphone Configuration"),m.a.createElement("form",{style:{fontSize:"1.8em"}},m.a.createElement("div",{style:{clear:"both",width:"100%"}},m.a.createElement("div",{style:{float:"right"}},m.a.createElement(q,{inputvolume:this.props.config.inputvolume,addInputGainNode:this.props.addInputGainNode,source:this.source,style:{float:"right",marginRight:"2em",height:"200",width:"50",dtooLoudColor:"#FF9800",scolor:"#889bd8",border:"1px solid black",backgroundColor:"lightgrey"}})),m.a.createElement("div",{style:{width:"80%"}},m.a.createElement("div",{className:"form-group"},m.a.createElement("b",{style:{marginBottom:"0.8em"}},"Volume\xa0\xa0\xa0")),m.a.createElement("div",{className:"form-group"},m.a.createElement("label",{htmlFor:"inputvolume"},"Microphone "),m.a.createElement("input",{type:"range",id:"inputvolume",value:o.inputvolume,onChange:this.configurationChange.bind(this),style:Object.assign({width:"80%"},n),min:"0",max:"200"})),m.a.createElement("div",{className:"form-group"},m.a.createElement("label",{htmlFor:"outputvolume"},"Output "),m.a.createElement("input",{type:"range",id:"outputvolume",value:o.outputvolume,onChange:this.configurationChange.bind(this),style:Object.assign({width:"80%"},n)})),m.a.createElement("div",{className:"form-group"},m.a.createElement("label",{htmlFor:"voicevolume"},"Voice "),m.a.createElement("input",{type:"range",id:"voicevolume",value:o.voicevolume,onChange:this.configurationChange.bind(this),style:Object.assign({width:"80%"},n)})))),m.a.createElement("div",{style:{clear:"both",width:"100%"},className:"form-group"},m.a.createElement("hr",{style:{width:"100%"}})),m.a.createElement("div",{className:"form-group"},m.a.createElement("label",{htmlFor:"hotword"},"Hotword "),m.a.createElement("select",{style:n,id:"hotword",value:o.hotword,onChange:this.configurationChange.bind(this)},m.a.createElement("option",{value:"browser:ok lamp"},"OK Lamp (Browser)"),m.a.createElement("option",{value:"browser:navy blue"},"Navy Blue (Browser)"),m.a.createElement("option",{value:"disabled"},"Disabled"))),m.a.createElement("div",{className:"form-group"},m.a.createElement("label",{htmlFor:"hotwordsensitivity"},"Hotword Sensitivity "),m.a.createElement("input",{type:"range",id:"hotwordsensitivity",value:o.hotwordsensitivity,onChange:this.configurationChange.bind(this),style:Object.assign({width:"80%"},n)})),m.a.createElement("div",{className:"form-group"},m.a.createElement("hr",{style:{width:"100%"}})),m.a.createElement("div",{className:"form-group"},m.a.createElement("b",{style:{marginBottom:"0.8em"}},"Notifications\xa0\xa0\xa0")),m.a.createElement("div",{className:"form-inline"},m.a.createElement("label",{htmlFor:"enabletts"}," Voice "),m.a.createElement("select",{style:n,id:"enabletts",value:o.enabletts,onChange:this.configurationChange.bind(this)},m.a.createElement("option",{value:"yes"},"Yes"),m.a.createElement("option",{value:"no"},"No")),m.a.createElement("label",{htmlFor:"enableaudio"}," Audio "),m.a.createElement("select",{style:n,id:"enableaudio",value:o.enableaudio,onChange:this.configurationChange.bind(this)},m.a.createElement("option",{value:"yes"},"Yes"),m.a.createElement("option",{value:"no"},"No")),m.a.createElement("label",{htmlFor:"enablenotifications"}," Screen "),m.a.createElement("select",{style:n,id:"enablenotifications",value:o.enablenotifications,onChange:this.configurationChange.bind(this)},m.a.createElement("option",{value:"yes"},"Yes"),m.a.createElement("option",{value:"no"},"No"))),m.a.createElement("div",{className:"form-group"},m.a.createElement("hr",{style:{width:"100%"}})),m.a.createElement("div",{className:"form-inline"},m.a.createElement("label",{htmlFor:"ttsvoice"},"Voice "),m.a.createElement("select",{style:n,id:"ttsvoice",value:o.ttsvoice,onChange:this.configurationChange.bind(this)},e),"\xa0\xa0\xa0",m.a.createElement("button",{className:"btn btn-success",style:{fontSize:"1em"},onClick:this.sendTestSay.bind(this)},"Test")),m.a.createElement("div",{className:"form-group"},m.a.createElement("label",{htmlFor:"voicerate"},"Rate "),m.a.createElement("input",{type:"range",id:"voicerate",value:o.voicerate,onChange:this.configurationChange.bind(this),style:Object.assign({width:"80%"},n)})),m.a.createElement("div",{className:"form-group"},m.a.createElement("label",{htmlFor:"voicepitch"},"Pitch "),m.a.createElement("input",{type:"range",id:"voicepitch",value:o.voicepitch,onChange:this.configurationChange.bind(this),style:Object.assign({width:"80%"},n)})),m.a.createElement("div",{className:"form-group"},m.a.createElement("hr",{style:{width:"100%"}}),m.a.createElement("span",{onClick:this.resetConfig},m.a.createElement("button",{className:"btn btn-danger",style:{fontSize:"1em"}}," ",t," Reset Configuration")),m.a.createElement("hr",{style:{width:"100%"}})),m.a.createElement("div",{className:"form-group"},m.a.createElement("br",null),m.a.createElement("br",null),m.a.createElement("br",null)))))}}]),t}(),G=function(e){function t(e){w(this,t);var n=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));n.siteId=e.siteId?e.siteId:"browser_"+parseInt(1e8*Math.random(),10),n.inputGainNodes=[],n.state={showConfig:!1,config:{}},n.setLogData=n.setLogData.bind(n),n.setConfig=n.setConfig.bind(n),n.showConfig=n.showConfig.bind(n),n.hideConfig=n.hideConfig.bind(n),n.addInputGainNode=n.addInputGainNode.bind(n),n.logger=e.logger?e.logger:new HermodLogger(Object.assign({logAudio:!1,setLogData:n.setLogData},e));var o=localStorage.getItem(n.appendUserId("Hermodmicrophone_config",e.user)),i=null;try{i=JSON.parse(o)}catch(a){}if(i)n.state.config=i;else{var s=n.getDefaultConfig();n.state.config=s,localStorage.setItem(n.appendUserId("Hermodmicrophone_config",n.props.user),JSON.stringify(s))}return n}return C(t,e),y(t,[{key:"appendUserId",value:function(e,t){return t&&t._id?e+"_"+t._id:e}},{key:"componentDidMount",value:function(){}},{key:"setLogData",value:function(e,t,n,o,i,s){this.setState(this.state)}},{key:"setConfig",value:function(e){this.setState({config:e})}},{key:"showConfig",value:function(){this.setState({showConfig:!0})}},{key:"hideConfig",value:function(){this.setState({showConfig:!1})}},{key:"addInputGainNode",value:function(e){this.inputGainNodes.push(e)}},{key:"getDefaultConfig",value:function(){return{inputvolume:"70",outputvolume:"70",voicevolume:"70",ttsvoice:"default",voicerate:"50",voicepitch:"50",hotword:"browser:oklamp",hotwordsensitivity:"50",enabletts:"yes",enableaudio:"yes",enablenotifications:"yes"}}},{key:"render",value:function(){var e=this.props.position?this.props.position:"top left";return m.a.createElement("div",{id:"Hermodreactsatellite"},m.a.createElement(L,b({},this.props,{position:e,logger:this.logger,siteId:this.siteId,config:this.state.config,showConfig:this.showConfig,hideConfig:this.hideConfig,addInputGainNode:this.addInputGainNode})),m.a.createElement("div",{style:{width:"100%",clear:"both"}},"\xa0"),this.state.showConfig&&m.a.createElement(j,b({},this.props,{setConfig:this.setConfig,configurationChange:this.setConfig,hideConfig:this.hideConfig,config:this.state.config,addInputGainNode:this.addInputGainNode,inputGainNodes:this.inputGainNodes})))}},{key:"drender",value:function(){var e=this.props.position?this.props.position:"top left";return m.a.createElement("div",{id:"Hermodreactsatellite"},m.a.createElement(P,b({},this.props,{logger:this.logger,siteId:this.siteId,config:this.state.config,addInputGainNode:this.addInputGainNode})),m.a.createElement(L,b({},this.props,{position:e,logger:this.logger,siteId:this.siteId,config:this.state.config,showConfig:this.showConfig,hideConfig:this.hideConfig,addInputGainNode:this.addInputGainNode})),m.a.createElement(F,b({},this.props,{logger:this.logger,siteId:this.siteId,config:this.state.config})),m.a.createElement(T,b({},this.props,{logger:this.logger,siteId:this.siteId,config:this.state.config})),this.props.intents&&m.a.createElement(A,b({},this.props,{logger:this.logger,siteId:this.siteId,config:this.state.config})),m.a.createElement("div",{style:{width:"100%",clear:"both"}},"\xa0"),this.state.showConfig&&m.a.createElement(j,b({},this.props,{setConfig:this.setConfig,configurationChange:this.setConfig,hideConfig:this.hideConfig,config:this.state.config,addInputGainNode:this.addInputGainNode,inputGainNodes:this.inputGainNodes})))}}]),t}(v.Component),H=function(e){function t(e){var n;return Object(r.a)(this,t),(n=Object(u.a)(this,Object(c.a)(t).call(this,e))).state={},n.setLogData=n.setLogData.bind(Object(h.a)(Object(h.a)(n))),n.siteId="browser_demo",n.logger=new _(Object.assign({subscribe:"#",siteId:n.siteId,username:"admin",password:"admin",logAudio:!0,setLogData:n.setLogData},e)),n.intents={"syntithenai:open_window":function(e){var t=this;return new Promise(function(n,o){var i=t.cleanSlots(e.slots);console.log(i,t),t.logger.say(e.siteId,"open window "+i.search_topic.value),n()})},"syntithenai:close_window":function(e){var t=this;return new Promise(function(n,o){var i=t.cleanSlots(e.slots);console.log(i,t),t.logger.say(e.siteId,"close window "+i.search_topic.value),n()})},"syntithenai:list_windows":function(e){var t=this;return new Promise(function(n,o){t.logger.say(e.siteId,"weather is eek"),n()})},"syntithenai:get_time":function(e){var t=this;return new Promise(function(n,o){var i=new Date,s=i.getMinutes(),a=i.getHours(),r=a>11?"PM":"AM";a%=12,s<10&&(s="0"+s),t.logger.say(e.siteId,"The time is "+a+":"+s+" "+r),n()})},"syntithenai:get_date":function(e){var t=this;return new Promise(function(n,o){var i=new Date,s=i.getDate(),a=["January","February","March","April","May","June","July","August","September","October","November","December"][i.getMonth()],r=i.getFullYear();t.logger.say(e.siteId,"The date is "+s+" "+a+" "+r),n()})}},n}return Object(d.a)(t,e),Object(l.a)(t,[{key:"setLogData",value:function(e,t,n,o,i,s){this.setState(this.state)}},{key:"startWaiting",value:function(){this.state.waiting||this.setState({waiting:!0})}},{key:"stopWaiting",value:function(){this.state.waiting&&this.setState({waiting:!1})}},{key:"onLogin",value:function(e,t){this.setState({user:e,token:t})}},{key:"onLogout",value:function(){this.setState({user:null,token:null})}},{key:"render",value:function(){return i.a.createElement("div",null,i.a.createElement(G,{logger:this.logger,siteId:this.siteId,intents:this.intents}),i.a.createElement("br",null),i.a.createElement("br",null),i.a.createElement("br",null),i.a.createElement("br",null),i.a.createElement("br",null),i.a.createElement("br",null),i.a.createElement("br",null),i.a.createElement("hr",null),i.a.createElement(B,Object.assign({logger:this.logger},this.logger.state,{siteId:null})),i.a.createElement("hr",null),i.a.createElement(U,Object.assign({logger:this.logger},this.logger.state,{siteId:null})))}}]),t}(o.Component);a.a.render(i.a.createElement(H,null),document.getElementById("root"))},57:function(e,t,n){e.exports=n(151)},62:function(e,t,n){},74:function(e,t){},76:function(e,t){}},[[57,2,1]]]);
//# sourceMappingURL=main.4d7ec406.chunk.js.map